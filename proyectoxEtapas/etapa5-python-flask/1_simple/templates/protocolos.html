{% extends "base.html" %}

{% block title %}Protocolos del Modelo OSI{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="hero-section bg-info text-white py-4 rounded mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold">
                    <i class="fas fa-list me-3"></i>
                    Protocolos del Modelo OSI
                </h1>
                <p class="lead">Explora y gestiona los protocolos que hacen posible la comunicación en redes</p>
            </div>
            <div class="col-lg-4 text-center">
                <i class="fas fa-network-wired fa-4x opacity-75"></i>
            </div>
        </div>
    </div>

</div>

<!-- Formulario para agregar protocolos -->
<div class="container mb-5">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-plus me-2"></i>
                Agregar Nuevo Protocolo
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('protocolos') }}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nombre" class="form-label">
                            <i class="fas fa-tag me-1"></i>
                            Nombre del Protocolo
                        </label>
                        <input type="text" class="form-control" id="nombre" name="nombre" 
                               placeholder="Ej: Transmission Control Protocol" required>
                        <div class="form-text">Nombre completo del protocolo</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="acronimo" class="form-label">
                            <i class="fas fa-font me-1"></i>
                            Acrónimo
                        </label>
                        <input type="text" class="form-control" id="acronimo" name="acronimo" 
                               placeholder="Ej: TCP" required>
                        <div class="form-text">Abreviatura del protocolo</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nombreCapa" class="form-label">
                            <i class="fas fa-layer-group me-1"></i>
                            Capa del Modelo OSI
                        </label>
                        <select class="form-select" id="nombreCapa" name="nombreCapa" required>
                            <option value="">Selecciona una capa</option>
                            <option value="Capa 7 - Aplicación">Capa 7 - Aplicación</option>
                            <option value="Capa 6 - Presentación">Capa 6 - Presentación</option>
                            <option value="Capa 5 - Sesión">Capa 5 - Sesión</option>
                            <option value="Capa 4 - Transporte">Capa 4 - Transporte</option>
                            <option value="Capa 3 - Red">Capa 3 - Red</option>
                            <option value="Capa 2 - Enlace de Datos">Capa 2 - Enlace de Datos</option>
                            <option value="Capa 1 - Física">Capa 1 - Física</option>
                        </select>
                        <div class="form-text">Capa del modelo OSI a la que pertenece</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="descripcion" class="form-label">
                            <i class="fas fa-align-left me-1"></i>
                            Descripción
                        </label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" 
                                  placeholder="Describe la función y características del protocolo" required></textarea>
                        <div class="form-text">Explicación del propósito del protocolo</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>
                        Guardar Protocolo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla de protocolos -->
<div class="container">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Protocolos Registrados
            </h4>
        </div>
        <div class="card-body">
            {% if protocolos %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    <i class="fas fa-hashtag me-1"></i>
                                    ID
                                </th>
                                <th>
                                    <i class="fas fa-tag me-1"></i>
                                    Nombre
                                </th>
                                <th>
                                    <i class="fas fa-font me-1"></i>
                                    Acrónimo
                                </th>
                                <th>
                                    <i class="fas fa-layer-group me-1"></i>
                                    Capa
                                </th>
                                <th>
                                    <i class="fas fa-align-left me-1"></i>
                                    Descripción
                                </th>
                                <th>
                                    <i class="fas fa-calendar me-1"></i>
                                    Fecha Actualización
                                </th>
                                <th>
                                    <i class="fas fa-cogs me-1"></i>
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for protocolo in protocolos %}
                            {# Normalizar a variables: soportar tuplas (índices) o diccionarios (claves) #}
                            {% set is_map = protocolo is mapping %}
                            {% set id = protocolo['id'] if is_map and 'id' in protocolo else (protocolo[0] if not is_map else None) %}
                            {% set nombre = protocolo['nombre'] if is_map and 'nombre' in protocolo else (protocolo[1] if not is_map else '') %}
                            {% set acronimo = protocolo['acronimo'] if is_map and 'acronimo' in protocolo else (protocolo[2] if not is_map else '') %}
                            {% set capa = protocolo['nombreCapa'] if is_map and 'nombreCapa' in protocolo else (protocolo[3] if not is_map else '') %}
                            {% set fecha = protocolo['fechaActualizacion'] if is_map and 'fechaActualizacion' in protocolo else (protocolo[4] if not is_map else None) %}
                            {% set descripcion = protocolo['descripcion'] if is_map and 'descripcion' in protocolo else (protocolo[5] if not is_map else '') %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ id }}</span>
                                </td>
                                <td>
                                    <strong>{{ nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ acronimo }}</span>
                                </td>
                                <td>
                                    {% if "Capa 7" in capa %}
                                        <span class="badge bg-danger">{{ capa }}</span>
                                    {% elif "Capa 6" in capa %}
                                        <span class="badge bg-warning text-dark">{{ capa }}</span>
                                    {% elif "Capa 5" in capa %}
                                        <span class="badge bg-info">{{ capa }}</span>
                                    {% elif "Capa 4" in capa %}
                                        <span class="badge bg-success">{{ capa }}</span>
                                    {% elif "Capa 3" in capa %}
                                        <span class="badge bg-primary">{{ capa }}</span>
                                    {% elif "Capa 2" in capa %}
                                        <span class="badge bg-secondary">{{ capa }}</span>
                                    {% elif "Capa 1" in capa %}
                                        <span class="badge bg-dark">{{ capa }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ capa }}</span>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    {{ descripcion }}
                                </td>
                                <td>
                                    {{ fecha or 'N/A' }}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                data-bs-toggle="modal" data-bs-target="#modalProtocolo{{ id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="{{ url_for('eliminar_protocolo_ruta', id=id) }}" 
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('¿Estás seguro de que quieres eliminar este protocolo?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Estadísticas por capa -->
                {# Contadores seguros para listas de tuplas o dicts #}
                {% set ns = namespace(c7=0, c6=0, c5=0, c4=0, c3=0, c2=0, c1=0) %}
                {% for p in protocolos %}
                    {% set is_map = p is mapping %}
                    {% set capa_val = p['nombreCapa'] if is_map and 'nombreCapa' in p else (p[3] if not is_map else '') %}
                    {% if 'Capa 7' in capa_val %}{% set ns.c7 = ns.c7 + 1 %}{% endif %}
                    {% if 'Capa 6' in capa_val %}{% set ns.c6 = ns.c6 + 1 %}{% endif %}
                    {% if 'Capa 5' in capa_val %}{% set ns.c5 = ns.c5 + 1 %}{% endif %}
                    {% if 'Capa 4' in capa_val %}{% set ns.c4 = ns.c4 + 1 %}{% endif %}
                    {% if 'Capa 3' in capa_val %}{% set ns.c3 = ns.c3 + 1 %}{% endif %}
                    {% if 'Capa 2' in capa_val %}{% set ns.c2 = ns.c2 + 1 %}{% endif %}
                    {% if 'Capa 1' in capa_val %}{% set ns.c1 = ns.c1 + 1 %}{% endif %}
                {% endfor %}
                <div class="row mt-4 g-3">
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-danger text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c7 }}</h5>
                                <p class="card-text">Capa 7 - Aplicación</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-warning text-dark text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c6 }}</h5>
                                <p class="card-text">Capa 6 - Presentación</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c5 }}</h5>
                                <p class="card-text">Capa 5 - Sesión</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c4 }}</h5>
                                <p class="card-text">Capa 4 - Transporte</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c3 }}</h5>
                                <p class="card-text">Capa 3 - Red</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-secondary text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c2 }}</h5>
                                <p class="card-text">Capa 2 - Enlace de Datos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card bg-dark text-white text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ ns.c1 }}</h5>
                                <p class="card-text">Capa 1 - Física</p>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay protocolos registrados</h4>
                    <p class="text-muted">Agrega tu primer protocolo usando el formulario de arriba</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# Renderizar modales al final del body para evitar problemas de cierre y z-index #}
{% if protocolos %}
    {% for protocolo in protocolos %}
        {% set is_map = protocolo is mapping %}
        {% set id = protocolo['id'] if is_map and 'id' in protocolo else (protocolo[0] if not is_map else None) %}
        {% set nombre = protocolo['nombre'] if is_map and 'nombre' in protocolo else (protocolo[1] if not is_map else '') %}
        {% set acronimo = protocolo['acronimo'] if is_map and 'acronimo' in protocolo else (protocolo[2] if not is_map else '') %}
        {% set capa = protocolo['nombreCapa'] if is_map and 'nombreCapa' in protocolo else (protocolo[3] if not is_map else '') %}
        {% set fecha = protocolo['fechaActualizacion'] if is_map and 'fechaActualizacion' in protocolo else (protocolo[4] if not is_map else None) %}
        {% set descripcion = protocolo['descripcion'] if is_map and 'descripcion' in protocolo else (protocolo[5] if not is_map else '') %}
        <div class="modal fade" id="modalProtocolo{{ id }}" tabindex="-1" aria-labelledby="modalTitle{{ id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle{{ id }}">
                            <i class="fas fa-info-circle me-2"></i>
                            Detalles del Protocolo
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ID:</strong> {{ id }}</p>
                                <p><strong>Nombre:</strong> {{ nombre }}</p>
                                <p><strong>Acrónimo:</strong> {{ acronimo }}</p>
                                <p><strong>Capa:</strong> {{ capa }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Fecha de Actualización:</strong></p>
                                <p>{{ fecha or 'N/A' }}</p>
                            </div>
                        </div>
                        <hr>
                        <p><strong>Descripción:</strong></p>
                        <p>{{ descripcion }}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endif %}

<!-- Información sobre el modelo OSI -->
<div class="container mt-5">
    <div class="card bg-light">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-lightbulb me-2"></i>
                ¿Sabías que?
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>El modelo OSI tiene 7 capas</li>
                        <li><i class="fas fa-check text-success me-2"></i>Cada capa tiene funciones específicas</li>
                        <li><i class="fas fa-check text-success me-2"></i>Los protocolos operan en capas específicas</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>TCP/IP es el modelo más usado</li>
                        <li><i class="fas fa-check text-success me-2"></i>HTTP opera en la capa de aplicación</li>
                        <li><i class="fas fa-check text-success me-2"></i>IP opera en la capa de red</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 